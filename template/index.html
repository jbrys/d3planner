<%inherit file="/base.html"/>
<script type="text/javascript">
    var _affix;
    var _slots = {};
    var _valid_slots = ["shoulders", "head", "neck",
                        "hands", "chest", "wrists",
                        "finger", "waist",
                        "twohand", "legs", "shield",
                        "feet"];
    var _char = {};
    var _translate = {};

    function get_stat_color(min,max,val){
        return percent_to_color((val-min)/(max-min));
    }

    function percent_to_color(percent){
        R=Math.ceil(255*(1-percent));
        G=Math.floor(255*percent);
        B=parseInt(0);
        //alert([R,G,B]);
        R=R.toString(16);
        G=G.toString(16);
        B=B.toString(16);
        //alert([R,G,B]);

        while(R.length < 2){
            R = "0"+R;
        }
        while(G.length < 2){
            G = "0"+G;
        }
        while(B.length < 2){
            B = "0"+B;
        }

        return "#"+R+G+B;
    }

    function item_change(){
        var ddl = $(this);
        var slot = ddl.parents(".slot").prop("id");
        var item_name = ddl.find("option:selected").text();
        var item = _slots[slot].items[item_name];

        if(!item.joined){
            $.each(_affix.primary[item.cat], function(stat,value){
                if(item.primary)
                    item.primary[stat] = value;

            });
            item.joined = true;
        }

        $("#"+slot+" .affix .primary select").empty();
        if(item.primary) {
            $("#"+slot+" .affix .primary select").append($("<option></option>").html(""));
            $.each(item.primary, function(stat,value){
                $("#"+slot+" .affix .primary select")

                    .append($("<option></option>").html(_translate[stat].display).attr("value", stat));
            });
        }
        $("#"+slot+ " .chosen-select").trigger("chosen:updated");
    }
    function clear_slot(item_ddl){
        item_ddl.empty();
        item_ddl.append($("<option></option>").html(""));
    }
    function load_slot(cat, item_ddl, group){
        var slot = item_ddl.parents(".slot").prop("id");

        $.getJSON("${base}json/"+cat, function(data) {

            if (item_ddl.hasClass("group")){
                parent_item = $("<optgroup></optgroup>").attr("label",cat);
                item_ddl.append(parent_item);
            }
            else{
                parent_item = item_ddl;
            }

            $.each(data.items, function(key, item) {
                item.cat = cat;
                parent_item.append($("<option></option>").html(key));
            });


			if(_slots[slot])
				$.extend(_slots[slot].items, data.items);
			else
				_slots[slot] = data;

        });
    }
    function load_ddl(item_ddl){
        clear_slot(item_ddl);
        $.each(item_ddl.attr("class").split(/\s+/), function(i, slot){
            if($.inArray(slot, _valid_slots) > -1){
                load_slot(slot, item_ddl, false);
            }
        });
        item_ddl.parent().children(".chosen-select").trigger("chosen:updated");
    }

    function update_char(){
        $.each(_char, function(slot,item){
            var slot_div = $("#"+slot);
            slot_div.find(".name").html(item.name);
            var affixes_div = slot_div.find(".view .affixes");

            affixes_div.empty();
            $.each(item.affixes.primary, function(index,affix){
                var affix_div = $("#templates .affix").clone(true,true);
                var display_val = get_display_value(affix.val, affix.scale);

                var template = _translate[affix.name].template || _translate[affix.name].display;

                affix_div.find(".type").html(template.replace("{0}", display_val)).attr("affix", affix.name);
                affix_div.find(".value")
                    .attr("min", affix.min)
                    .attr("max", affix.max)
                    .attr("val", affix.val)
                    .attr("step", affix.step)
                    .attr("scale", affix.scale)
                    .find(".edit_affix_button")
                        .click(edit_affix);

                affixes_div.append(affix_div).append($("<div style='clear: both;'></div>"));
            });
        });
        save_cookie();
    }

    function save_cookie(){
        $.each(_char, function(slot, data){
            $.cookie('d3planner_'+slot, data);
        });
    }
    function load_cookie(){
        $(".slot").each(function(){
            var slot = $(this).attr("id");
            var cookie_name = 'd3planner_'+slot;
            if($.cookie(cookie_name))
                _char[slot] = $.cookie(cookie_name);
        });
    }

    function edit_affix(){
        var affix_div = $(this).parents(".affix");
        var edit_div = affix_div.find(".edit_affix");
        edit_div.toggle();
        if(edit_div.is(':visible')){
            var value_div = affix_div.find(".value");
            var min = parseInt(value_div.attr("min"));
            var max = parseInt(value_div.attr("max"));
            var val = parseInt(value_div.attr("val"));
            var step = parseInt(value_div.attr("step") || 1);

            affix_div.find(".slider").slider({
                value : val,
                min : min,
                max : max,
                step : step,
                slide : on_slider
            });
        }
        else{
            save_cookie();
        }
        return false;
    }

    function get_display_value(val, scale){
        var display_val = String(val/Math.pow(10, scale || 0));

        if(scale > 0){
            if(display_val.indexOf(".") < 0){
                display_val += ".";
            }
            while(display_val.split(".")[1].length < scale){
                display_val += "0";
            }
        }
        return display_val;
    }

    function on_slider(event, ui) {
        var affix_div = $(this).parents(".affix");
        var affix = $(this).parents(".affix").find(".type").attr("affix");
        var slot_div = affix_div.parents(".slot");
        var slot = slot_div.attr("id");

        var value_div = affix_div.find(".value");
        var val = parseInt(ui.value);
        var scale = parseInt(value_div.attr("scale"));

        var template = _translate[affix].template || _translate[affix].display;

        var display_val = get_display_value(val, scale);
        _char[slot].affixes.primary[affix].val = ui.value;

        affix_div.find(".type").html(template.replace("{0}", display_val)).attr("affix", affix);
        affix_div.find(".value").attr("val", val);
    }

    $(document).ready(function(){
        $.cookie.json = true;
        $("#debug").click(function(){$("#debug_output").html(JSON.stringify(_translate));});
        $(".item").change(item_change);
        $.ajaxSetup({
            async: false
        });
        $.getJSON("${base}json/affix", function(data) {
            _affix = data;
        });
        $.getJSON("${base}json/translate", function(data) {
            _translate = data;
        });
        $(".item").each(function(i, item_ddl){
            load_ddl($(item_ddl));
        });

        $(".edit_button").click(function(){
            $(this)
                .parents(".view").hide()
                .parents(".slot").children(".edit").show()
                .find(".chosen-select").chosen();
            return false;
        });
        $(".cancel_button").click(function(){
            $(this)
                .parents(".edit").hide()
                .parents(".slot").children(".view").show();
            return false;
        });
        $(".save_button").click(function(){
            var slot_div = $(this).parents(".slot");
            var slot = slot_div.attr("id");
            var item_name = slot_div.find(".item option:selected").text();
            var item = _slots[slot].items[item_name];

            _char[slot] = {};
            _char[slot].name = item_name;

            _char[slot].affixes = {};
            _char[slot].affixes.primary = {};

            slot_div.find(".primary option:selected").each(function(index, affix_node){
                affix_name = $(affix_node).attr("value");
                affix_data = item.primary[affix_name]
                affix = {};
                affix.name = affix_name;
                affix.min = affix_data.min;
                affix.max = affix_data.max;
                affix.val = affix_data.max;
                affix.step = affix_data.step;
                affix.scale = affix_data.scale;

                _char[slot].affixes.primary[affix_name] = affix;
            });
            update_char();

            $(this)
                .parents(".edit").hide()
                .parents(".slot").children(".view").show();
            return false;
        });
        load_cookie();
        update_char();
    });
</script>

<a id="debug" href="#">debug</a>
<div id="debug_output"></div>
<div id="templates" style="display:none;">
    <div class="affix">
        <div class="view_affix">
            <span class="type"></span><span class="value"><span class="ui-icon ui-icon-gear edit_affix_button"></span></span>
        </div>
        <div class="edit_affix" style="display: none;">
            <br>
            <div class="slider"></div>
        </div>
    </div>
    <div class="total_affix"></div>
</div>


<div class ="center_contents">
    <div class="paperdoll">
        <div class="equipment_row">
            <div class="slot" id="shoulders">
                shoulders
                <br>
                <div class="edit">
                    <select class="item shoulders chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
            <div class="slot" id="head">
                head
                <br>
                <div class="edit">
                    <select class="item head chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
            <div class="slot" id="neck">
                neck
                <br>
                <div class="edit">
                    <select class="item neck chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="equipment_row">
            <div class="slot" id="hands">
                hands
                <br>
                <div class="edit">
                    <select class="item hands chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
            <div class="slot" id="chest">
                chest
                <br>
                <div class="edit">
                    <select class="item chest chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
            <div class="slot" id="wrists">
                wrists
                <br>
                <div class="edit">
                    <select class="item wrists chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="equipment_row">
            <div class="slot" id="lfinger">
                finger
                <br>
                <div class="edit">
                    <select class="item finger chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
            <div class="slot" id="waist">
                waist
                <br>
                <div class="edit">
                    <select class="item waist chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
            <div class="slot" id="rfinger">
                finger
                <br>
                <div class="edit">
                    <select class="item finger chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="equipment_row">
            <div class="slot" id="mainhand">
                mainhand
                <br>
                <div class="edit">
                    <select class="item group onehand twohand chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
            <div class="slot" id="legs">
                legs
                <br>
                <div class="edit">
                    <select class="item legs chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
            <div class="slot" id="offhand">
                offhand
                <br>
                <div class="edit">
                    <select class="item group shield mojo source quiver cshield chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="equipment_row">
            <div class="slot" id="feet">
                feet
                <br>
                <div class="edit">
                    <select class="item feet chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <span class="ui-icon ui-icon-check save_button"></span>
                        <span class="ui-icon ui-icon-close cancel_button"></span>
                    </div>
                </div>
                <div class="view">
                    <div><div class="name"></div><span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
                    <div style="clear: both;"></div>
                    <div class="affixes"></div>
                </div>
            </div>
        </div>
    </div>
</div>