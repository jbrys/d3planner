<%inherit file="/base.html"/>
<script type="text/javascript">
    var _affix;
    var _slots = {};
    var _valid_slots = ["head"];
    var _char = {};

    function item_change(){
        var ddl = $(this);
        var slot = ddl.parents(".slot").prop("id");
        var item_name = ddl.children("option:selected").text();
        var item = _slots[slot].items[item_name];

        if(!item.joined){
            $.each(_affix.primary[slot], function(stat,value){
                if(item.primary)
                    item.primary[stat] = value;

            });
            item.joined = true;
        }

        $("#"+slot+" .affix .primary select").empty();
        if(item.primary) {
            $("#"+slot+" .affix .primary select").append($("<option></option>").html(""));
            $.each(item.primary, function(stat,value){
                $("#"+slot+" .affix .primary select")
                    .append($("<option></option>").html(stat));
            });
        }
        $("#"+slot+ " .chosen-select").trigger("chosen:updated");
    }
    function clear_slot(item_ddl){
        item_ddl.empty();
        item_ddl.append($("<option></option>").html(""));
    }
    function load_slot(slot, item_ddl, group){
        $.getJSON("${base}json/"+slot, function(data) {
            _slots[slot] = data;
            if (item_ddl.hasClass("group")){
                parent_item = $("<optgroup></optgroup>").attr("label",slot);
                item_ddl.append(parent_item);
            }
            else{
                parent_item = item_ddl;
            }
            $.each(data.items, function(key, item) {
                parent_item.append($("<option></option>").html(key));
            });
        });
    }
    function load_ddl(item_ddl){
        clear_slot(item_ddl);
        $.each(item_ddl.attr("class").split(/\s+/), function(i, slot){
            if($.inArray(slot, _valid_slots) > -1){
                load_slot(slot, item_ddl, false);
            }
        });
        item_ddl.parent().children(".chosen-select").trigger("chosen:updated");
    }

    function update_char(){
        $.each(_char, function(slot,item){
            slot_div = $("#"+slot);
            slot_div.find(".name").html(item.name);
            affixes_div = slot_div.find(".view .affixes");

            affixes_div.empty();
            $.each(item.affixes.primary, function(index,affix){
                affix_div = $("#templates .affix").clone(true,true);

                affix_div.children(".type").html(affix.name);
                affix_div.children(".value")
                    .attr("min", affix.min)
                    .attr("max", affix.max)
                    .attr("val", affix.val)
                    .html(affix.max);

                affixes_div.append(affix_div).append($("<div style='clear: both;'></div>"));
            });
        });
    }

    $(document).ready(function(){
        $(".item").change(item_change);
        $.getJSON("${base}json/affix", function(affix) {
            _affix = affix;
        });
        $(".item").each(function(i, item_ddl){
            load_ddl($(item_ddl));
        });

        $(".edit_button a").click(function(){
            $(this)
                .parents(".view").hide()
                .parents(".slot").children(".edit").show()
                .find(".chosen-select").chosen();
            return false;
        });
        $(".cancel_button a").click(function(){
            $(this)
                .parents(".edit").hide()
                .parents(".slot").children(".view").show();
            return false;
        });
        $(".save_button a").click(function(){
            var slot_div = $(this).parents(".slot");
            var slot = slot_div.attr("id");
            var item_name = slot_div.find(".item option:selected").text();
            var item = _slots[slot].items[item_name];

            _char[slot] = {};
            _char[slot].name = item_name;

            _char[slot].affixes = {};
            _char[slot].affixes.primary = [];

            slot_div.find(".primary option:selected").each(function(index, affix_node){
                affix_name = $(affix_node).text();
                affix_data = item.primary[affix_name]
                affix = {};
                affix.name = affix_name;
                affix.min = affix_data.min;
                affix.max = affix_data.max;
                affix.val = affix_data.max;

                _char[slot].affixes.primary.push(affix);
            });
            update_char();

            $(this)
                .parents(".edit").hide()
                .parents(".slot").children(".view").show();
            return false;
        });
    });
</script>
<div id="templates" style="display:none;">
    <div class="affix">
        <span class="type"></span><span class="value"></span>
    </div>
</div>


<div class ="center_contents">
    <div class="paperdoll">
        <div class="equipment_row">
            <div class="slot" id="shoulders">
                shoulders
                <br>
                <div class="edit">
                    <select class="item shoulders chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
            <div class="slot" id="head">
                head
                <br>
                <div class="edit">
                    <select class="item head chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
            <div class="slot" id="neck">
                neck
                <br>
                <div class="edit">
                    <select class="item neck chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="equipment_row">
            <div class="slot" id="hands">
                hands
                <br>
                <div class="edit">
                    <select class="item hands chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
            <div class="slot" id="chest">
                chest
                <br>
                <div class="edit">
                    <select class="item chest chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
            <div class="slot" id="wrists">
                wrists
                <br>
                <div class="edit">
                    <select class="item wrists chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="equipment_row">
            <div class="slot" id="lfinger">
                finger
                <br>
                <div class="edit">
                    <select class="item finger chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
            <div class="slot" id="waist">
                waist
                <br>
                <div class="edit">
                    <select class="item waist chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
            <div class="slot" id="rfinger">
                finger
                <br>
                <div class="edit">
                    <select class="item finger chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="equipment_row">
            <div class="slot" id="mainhand">
                mainhand
                <br>
                <div class="edit">
                    <select class="item group onehand twohand chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
            <div class="slot" id="legs">
                legs
                <br>
                <div class="edit">
                    <select class="item legs chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
            <div class="slot" id="offhand">
                offhand
                <br>
                <div class="edit">
                    <select class="item group shield mojo source quiver cshield chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
        </div>
        <div style="clear: both;"></div>
        <div class="equipment_row">
            <div class="slot" id="feet">
                feet
                <br>
                <div class="edit">
                    <select class="item feet chosen-select"></select>
                    <div class="affix">
                        <div class="primary">
                            <select multiple class="chosen-select"></select>
                        </div>
                    </div>
                    <div class="buttons">
                        <div class="save_button"><a href="#">save</a></div>
                        <div class="cancel_button"><a href="#">cancel</a></div>
                    </div>
                </div>
                <div class="view">
                    <div class="name"></div>
                    <div class="affixes"></div>
                    <div class="buttons">
                        <div class="edit_button"><a href="#">edit</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>