<%inherit file="/base.html"/>
<script type="text/javascript">
	var _debug = true;
    var _affix;
    var _slots = {};
    var _sets;
    var _valid_slots = [
    	"shoulders", "head", "neck",
		"hands", "chest", "wrists",
		"finger", "waist",
		"twohand", "legs", "shield",
		"feet"];

    var _cookies = [
    	"shoulders", "head", "neck",
        "hands", "chest", "wrists",
        "lfinger", "waist", "rfinger",
        "mainhand", "legs", "offhand",
        "feet",
        "settings", "skills"];

	var _stats = ["strength","dexterity","intelligence"];
    var _char = {};
    var _translate = {};
    var _bnet_translate = {};
    var _base_stats = {
        "main_stat" : 217,
        "off_stat" : 77,
        "vitality" : 147,
        "critical_hit_damage" : 50,
        "critical_hit_chance" : 50
    }
    var _defaults = {
        "max_damage": 3,
        "min_damage": 2,
        "strength": 217,
        "intelligence" : 217,
        "dexterity" : 217,
        "attack_speed": 0,
        "critical_hit_chance": 5,
        "critical_hit_damage": 50,
        "element_damage": 0,
        "elite_damage": 0,
        "attacks_per_second": 1
    };
	var _values;
    var _elements = ["holy_damage","fire_damage"];
	var _classes;

    function update_char(){
    	if(_char && _char.settings && _char.settings.class){
    		if($("#class_list").val() != _char.settings.class)
    			$("#class_list").val(_char.settings.class).trigger("chosen:updated").change();

			var totals = jQuery.extend(true, {}, _base_stats);
			$.each(_stats, function(i, stat){
				totals[stat] = get_char_affix("main_stat") == stat ? totals.main_stat : totals.off_stat;
			});
			var sets = {};
			var rorg_bonus = false;

			$(".legendary_affixes").empty();
			$(".set_bonuses").empty();

			$.each(_char, function(slot, item){
				var slot_div = $("#"+slot);
				if(item.name){
					var item_blob = _slots[slot].items[item.name];

					if(!item_blob){
						_char[slot] = {};
						return;
					}
					slot_div.find(".name").html(item.name || "");

					slot_div.addClass("legendary");
					if(item_blob.set){
						sets[item_blob.set] = (sets[item_blob.set] || 0) + 1
						slot_div.addClass("set");
						slot_div.removeClass("legendary");
					}
					var affixes_div = slot_div.find(".view .affixes");

					affixes_div.empty();
					$.each(item.affixes.primary, function(affix_name,affix){
						affix_name = get_char_affix(affix_name)
						if (affix_name == "socket"){
							join_item(item_blob);
							$.each(item_blob.socket_value || {}, function(socket_affix, value){
								socket_affix = get_char_affix(socket_affix)
								totals[socket_affix] = (totals[socket_affix] || 0) + value * affix.val;
							});
							totals[affix_name] = (totals[affix_name] || 0) + affix.val;
						}
						else{
							if (affix_name == "elemental_damage"){
								$.each(_elements, function(i, element){
									totals[element] = (totals[element] || 0) + affix.val;
								});
							}
							totals[affix_name] = (totals[affix_name] || 0) + affix.val;
						}
						var affix_div = $("#templates .affix").clone(true,true);

						affix_div.find(".type").html(get_template(affix_name, affix.val)).attr("affix", affix_name);

						affix_div
							.css("color",percent_to_color((affix.val-affix.min+1)/(affix.max-affix.min+1)))
							.find(".value")
								.attr("min", affix.min)
								.attr("max", affix.max)
								.attr("val", affix.val)
								.attr("step", affix.step)
								.attr("scale", affix.scale)
								.find(".edit_affix_button")
									.click(edit_affix);

						affixes_div.append(affix_div).append($("<div style='clear: both;'></div>"));
					});
					$.each(item_blob.legendary, function(index,affix){
						if(index == "ring_of_royal_grandeur_leg")
							rorg_bonus = true;
						var legendary_div = $("#templates .legendary_affix").clone(true);
						$(".legendary_affixes").append(legendary_div);
						legendary_div.html(get_template(index));
					});
				}
			});
			_char.sets = sets;

			$.each(sets, function(set_name,count){
				if (rorg_bonus && count > 1)
					count++;
				var append = false;
				var set_div = $("#templates .set").clone(true);
				$(".set_bonuses").append(set_div);
				for(var i = 2; i <= count; i++){
					set_div.find(".name").text(get_template(set_name));
					var set_bonus = _sets[set_name][i];
					if(set_bonus){
						 $.each(set_bonus, function(affix_type, affixes){
							$.each(affixes, function(affix, value){
								affix_div = $("#templates .set_affix").clone();
								affix_div.html(get_template(affix, value));
								set_div.find("."+affix_type).append(affix_div);

								affix = get_char_affix(affix)
								totals[affix] = (totals[affix] || 0) + value;
							});
						});
					}
				}
			});
			debug(JSON.stringify(totals));
			$.each(_char.skills.passive, function(i, passive){
				if(passive){
					debug(passive);
					if(_classes[_char.settings.class]
						&& _classes[_char.settings.class].skills
						&& _classes[_char.settings.class].skills.passive
						&& _classes[_char.settings.class].skills.passive[passive]){
						//
						simplify(_classes[_char.settings.class].skills.passive[passive],totals);
					}
				}
			});

			_char.totals = totals;

			save_to_cookie(_char);
			populate_values();
			calculate_totals();
			calculate_damage();
			skill_damage();
			$(".slot").each(function(i, slot_div){
				calculate_perfection($(slot_div).attr("id"));
			});
		}
    }

	function calculate_totals(){
		$(".elemental_damage").hide();
		$("#"+_values.element).show();
        $(".totals tr").each(function(i,tr){
            tr = $(tr);
            var affix = tr.attr("id");
            if(affix){
				var value = _char.totals[affix] || 0;
				var scale = _translate[affix].scale || 0;

				tr.children().html(get_template(affix, value));
            }
        });
	}

    function edit_affix(){
        var affix_div = $(this).parents(".affix");
        var edit_div = affix_div.find(".edit_affix");
        edit_div.toggle();
        if(edit_div.is(':visible')){
            var value_div = affix_div.find(".value");
            var min = parseInt(value_div.attr("min"));
            var max = parseInt(value_div.attr("max"));
            var val = parseInt(value_div.attr("val"));
            var step = parseInt(value_div.attr("step") || 1);

            affix_div.find(".slider").slider({
                value : val,
                min : min,
                max : max,
                step : step,
                slide : on_slider
            });
        }
        else{
            update_char();
        }
        return false;
    }

	function calculate_perfection(slot){
		var slot_div = $("#"+slot);
		var percentages = [];
		$.each(slot_div.find(".value"), function(i, value_div){
			value_div = $(value_div);
            var min = parseInt(value_div.attr("min"));
            var max = parseInt(value_div.attr("max"));
            var val = parseInt(value_div.attr("val"));
            var step = parseInt(value_div.attr("step") || 1);

			percentages.push((val-min+1)/(max-min+1));
		});

		if (percentages.length > 0){
			var perfection = percentages.reduce(function(pv, cv) { return pv + cv; }, 0) / percentages.length
			slot_div.find(".perfection")
				.css("color",percent_to_color(perfection))
				.html(get_template("perfection",format_number(perfection*100,2,false)));

			if (perfection < 1){
				var dps_loss = calculate_dps_loss(slot);

				slot_div.find(".dps_loss")
						.css("color",percent_to_color(perfection))
						.html(get_template("dps_loss",format_number(dps_loss,0,false)));
			}
			else{
				slot_div.find(".dps_loss").empty();
			}
		}
		else{
			slot_div.find(".perfection").empty();
		}
	}

	function scale_to_real(value, scale){
		return value/Math.pow(10, scale || 0);
	}

	function calculate_dps_loss(slot){
		populate_values();
		perfect_values = jQuery.extend(true, {}, _values);

		var slot_div = $("#"+slot);
		$.each(slot_div.find(".view_affix"), function(i, affix_div){
			var affix = $(affix_div).find(".type").attr("affix");

			if (get_char_affix("main_stat") === affix)
				affix = "main_stat";

			if(perfect_values[affix]){
				value_div = $(affix_div).find(".value");
				var min = parseInt(value_div.attr("min"));
				var max = parseInt(value_div.attr("max"));
				var val = parseInt(value_div.attr("val"));
				var scl = parseInt(value_div.attr("scale"));

				perfect_values[affix] += scale_to_real(max-val,scl);
			}
			else if(perfect_values.element == affix){
				perfect_values.elemental_damage
			}
		});
		return calculate_dps(perfect_values,_defaults)-calculate_dps(_values,_defaults);
	}

    function on_slider(event, ui) {
        var affix_div = $(this).parents(".affix");
        var affix = $(this).parents(".affix").find(".type").attr("affix");
        var slot_div = affix_div.parents(".slot");
        var slot = slot_div.attr("id");

        var value_div = affix_div.find(".value");
        var val = parseInt(ui.value);
		var min = parseInt(value_div.attr("min"));
		var max = parseInt(value_div.attr("max"));
        var scale = parseInt(value_div.attr("scale"));

        _char[slot].affixes.primary[affix].val = ui.value;

        affix_div.find(".type").html(get_template(affix,val)).attr("affix", affix);
        affix_div.find(".value").attr("val", val);
        affix_div.css("color",percent_to_color((val-min+1)/(max-min+1)))
    }
    function edit_button(){
		var slot_div = $(this).parents(".slot");
		var slot = slot_div.attr("id");
		if(_char[slot]){
			var item_name = _char[slot].name;

			slot_div.find(".item option").filter(function() {
				return ($(this).text() == item_name);
			}).prop('selected', true).change();
		}
        $(this)
            .parents(".view").hide()
            .parents(".slot").children(".edit").show()
            .find(".chosen-select").chosen();
        return false;
    }
	function cancel_button(){
		$(this)
            .parents(".edit").hide()
			.parents(".slot").children(".view").show();
		return false;
	}
	function save_button(){
		var slot_div = $(this).parents(".slot");
		var slot = slot_div.attr("id");
		var item_name = slot_div.find(".item option:selected").text();
		var item = _slots[slot].items[item_name];

		var old_affixes = {};
		if (_char[slot] && _char[slot].affixes && _char[slot].affixes.primary)
			old_affixes = _char[slot].affixes.primary;

		_char[slot] = {};
		_char[slot].name = item_name;

		_char[slot].affixes = {};
		_char[slot].affixes.primary = {};

		slot_div.find(".primary option:selected").each(function(index, affix_node){
			affix_name = $(affix_node).attr("value");
			affix_data = item.primary[affix_name]
			affix = {};
			affix.name = affix_name;
			affix.min = affix_data.min;
			affix.max = affix_data.max;
			affix.val = old_affixes[affix_name] ? old_affixes[affix_name].val || affix_data.max : affix_data.max;
			affix.step = affix_data.step;
			affix.scale = affix_data.scale;

			_char[slot].affixes.primary[affix_name] = affix;
		});
		update_char();

		$(this)
			.parents(".edit").hide()
			.parents(".slot").children(".view").show();
		return false;
	}


    $(document).ready(function(){
        $.cookie.json = true;
        $.ajaxSetup({
            async: false
        });
        $.getJSON("${base}json/affix", function(data) {
            _affix = data;
        });
        $.getJSON("${base}json/translate", function(data) {
            _translate = data;
        });
        $.getJSON("${base}json/bnet_translate", function(data) {
            _bnet_translate = data;
        });
        $.getJSON("${base}json/sets", function(data) {
            _sets = data;
        });
        $.getJSON("${base}json/classes", function(data) {
            _classes = data;
        });
        $("#debug").click(function(){_debug=true;});
        $(".item").change(item_change);

        $(".edit_button").click(edit_button);
        $(".cancel_button").click(cancel_button);
        $(".save_button").click(save_button);
        $("#import_begin").click(import_begin);
        $("#import_end").click(import_end);
        $(".rune").change(rune_change);
        $(".passive").change(passive_change);
        $(".active").change(active_change);
        $("#fetch").click(fetch);
		$.each(_elements, function(i, element){
			$("#skill_element").append("<option value='{0}'>{1}</option>".format(element,_translate[element].dropdown));
		});
		$("#skill_percent").keyup(skill_damage);
		$("#skill_element").change(skill_damage);
		$("#skill_element").chosen({disable_search:true});

		$("#class_list").append("<option value='{0}'>{1}</option>".format("", ""));
		$.each(_classes, function(class_name, details){
			$("#class_list").append("<option value='{0}'>{1}</option>".format(class_name, _translate[class_name].dropdown));
		});

		$("#class_list").change(class_change);
		$("#class_list").chosen({disable_search:true});

		load_from_cookie(_char);
		update_char();
    });

    function class_change(){
    	if(!_char.settings)
    		_char.settings = {};

    	_char.settings.class = $(this).val();
    	save_to_cookie(_char);

		_classes[_char.settings.class].class_specific_slots

        $(".item").each(function(i, item_ddl){
            load_ddl($(item_ddl));
        });
        load_skills();
    	update_char();
    }

    function populate_values(){
    	var best_element = {
    		type: "elemental_damage",
    		val: _char.totals["elemental_damage"]
    	};

    	$.each(_elements, function(i, element){
			if (_char.totals[element] > best_element.val){
				best_element.type = element;
				best_element.val = _char.totals[element];
			}
    	});

		var main_stat = _classes[_char.settings.class].translate["main_stat"];

		_values = {
			max_damage: _char.totals.max_damage/Math.pow(10, _translate.max_damage.scale || 0),
			min_damage: _char.totals.min_damage/Math.pow(10, _translate.min_damage.scale || 0),
			main_stat: _char.totals[main_stat]/Math.pow(10, _translate[main_stat].scale || 0),
			attack_speed: _char.totals.attack_speed/Math.pow(10, _translate.attack_speed.scale || 0),
			critical_hit_chance: _char.totals.critical_hit_chance/Math.pow(10, _translate.critical_hit_chance.scale || 0),
			critical_hit_damage: _char.totals.critical_hit_damage/Math.pow(10, _translate.critical_hit_damage.scale || 0),
			element_damage: best_element.val/Math.pow(10, _translate[best_element.type].scale || 0),
			elite_damage: _char.totals.elite_damage/Math.pow(10, _translate.elite_damage.scale || 0),
			attacks_per_second: _char.totals.attacks_per_second/Math.pow(10, _translate.attacks_per_second.scale || 0),
			element: best_element.type
		};
    }
    function calculate_damage(){
        if (_char && _char.totals){
			var eled = 1+((_values.element_damage || _defaults.element_damage)/100);
			var elid = 1+((_values.elite_damage || _defaults.elite_damage)/100);

            var sheet_dps = calculate_dps(_values, _defaults);
            //var sheet_dps = ((max+min)/2)*(1+ms/100)*(1+as/100)*(aps)*(1+chc/100*chd/100);

            $("#sheet_dps .value").html(format_number(sheet_dps,0,true));
            $("#elemental_dps .value").html(format_number(sheet_dps*eled,0,true));
            $("#elite_dps .value").html(format_number(sheet_dps*elid,0,true));
            $("#elemental_elite_dps .value").html(format_number(sheet_dps*eled*elid,0,true));

            $("#sheet_dps .label").html(get_template("sheet_dps"));
            $("#elemental_dps .label").html(get_template("elemental_dps"));
            $("#elite_dps .label").html(get_template("elite_dps"));
            $("#elemental_elite_dps .label").html(get_template("elemental_elite_dps"));
        }
    }
	function skill_damage(){
		var percent = parseInt($("#skill_percent").val());
		var element = $("#skill_element").val();
		if(percent > 0)
		{
			var eled = 1+((_char.totals[element] || 0)/100);
			var elid = 1+((_values.elite_damage || _defaults.elite_damage)/100);

			var base_min = calculate_base_damage(_values, _defaults, _values.min_damage || _defaults.min_damage)*(percent/100);
			var base_max = calculate_base_damage(_values, _defaults, _values.max_damage || _defaults.max_damage)*(percent/100);
			var crit_min = calculate_crit_damage(_values, _defaults, base_min);
			var crit_max = calculate_crit_damage(_values, _defaults, base_max);

			$("#min").text(format_number(base_min,0,true));
			$("#max").text(format_number(base_max,0,true));
			$("#c_min").text(format_number(crit_min,0,true));
			$("#c_max").text(format_number(crit_max,0,true));

			$("#ele_min").text(format_number(base_min*eled,0,true));
			$("#ele_max").text(format_number(base_max*eled,0,true));
			$("#ele_c_min").text(format_number(crit_min*eled,0,true));
			$("#ele_c_max").text(format_number(crit_max*eled,0,true));

			$("#eli_min").text(format_number(base_min*elid,0,true));
			$("#eli_max").text(format_number(base_max*elid,0,true));
			$("#eli_c_min").text(format_number(crit_min*elid,0,true));
			$("#eli_c_max").text(format_number(crit_max*elid,0,true));

			$("#ele_eli_min").text(format_number(base_min*eled*elid,0,true));
			$("#ele_eli_max").text(format_number(base_max*eled*elid,0,true));
			$("#ele_eli_c_min").text(format_number(crit_min*eled*elid,0,true));
			$("#ele_eli_c_max").text(format_number(crit_max*eled*elid,0,true));
		}
	}

	function debug(data){
		if(_debug){
			$("#debug_output").prepend("<div>{0}<div>".format(data));
		}
	}

	function rune_change(){
		rune_ddl = $(this);
		var index = parseInt(rune_ddl.attr("id").replace("rune-",""));
		var rune = rune_ddl.val();
		var previous_rune = _char.skills.rune[index];
		_char.skills.rune[index] = rune;

		if(!rune)
			_char.skills.rune[index] = null;

		save_to_cookie(_char);
		update_char();
	}
	function passive_change(){
		var passive_ddl = $(this);
		var index = parseInt(passive_ddl.attr("id").replace("passive-",""));
		var previous_passive = _char.skills.passive[index];
		var current_passive = passive_ddl.val();
		_char.skills.passive[index] = current_passive;

		passive_ddl.siblings(".passive").children("option[value='"+previous_passive+"']").attr("disabled",false);
		if(current_passive)
			passive_ddl.siblings(".passive").children("option[value='"+current_passive+"']").attr("disabled",true);
		else
			_char.skills.passive[index] = null;

		save_to_cookie(_char);
		update_char();
	}
	function active_change(){
		active_ddl = $(this);
		var index = parseInt(active_ddl.attr("id").replace("active-",""));
		var rune_ddl = $("#rune-"+index);
		var previous_active = _char.skills.active[index];
		var current_active = active_ddl.val();
		_char.skills.active[index] = current_active;

		active_ddl.parent().siblings().find("option[value='"+previous_active+"']").attr("disabled",false);
		if(current_active){
			active_ddl.parent().siblings().find("option[value='"+current_active+"']").attr("disabled",true);
			rune_ddl.append(createOption(""));
			$.each(_classes[_char.settings.class].skills.active[current_active].runes, function(rune, data){
				rune_ddl
					.append(createOption(
						rune,
						rune,
						_char.skills.rune.length >= index && _char.skills.rune[index] == rune ? "selected" : ""));
			});
		}
		else{
			rune_ddl.empty();
			_char.skills.active[index] = null;
		}

		save_to_cookie(_char);
		update_char();
	}

	function load_skills(){
		if(_char && _char.settings && _char.settings.class){
			if(!_char.skills)
				_char.skills = { "passive": [,,,,], "active": [,,,,,,], "rune": [,,,,,,]}

			$(".passive").each(function(i, skill_select){
				skill_select = $(skill_select);
				skill_select.empty();
				skill_select.append(createOption(""));
				$.each(_classes[_char.settings.class].skills.passive, function(skill, skill_data){
					skill_select
						.append(createOption(
							skill,
							skill,
							_char.skills.passive.length >= i && _char.skills.passive[i] == skill,
							$.inArray(skill, _char.skills.passive) >= 0 && _char.skills.passive[i] != skill));
				});
			});
			$(".active").each(function(i, skill_select){
				skill_select = $(skill_select);
				skill_select.empty();
				skill_select.append("<option value='{0}'>{1}</option>".format("",""));
				$.each(_classes[_char.settings.class].skills.active, function(skill, skill_data){
					skill_select
						.append(createOption(
							skill,
							skill,
							_char.skills.active.length >= i && _char.skills.active[i] == skill,
							$.inArray(skill, _char.skills.active) >= 0 && _char.skills.active[i] != skill));
				});
			}).change();
		}
	}
</script>

<div id="templates" style="display:none;">
	<div class="affix">
		<div class="view_affix">
			<span class="type"></span><span class="value"><span
				class="ui-icon ui-icon-gear edit_affix_button"></span></span>
		</div>
		<div class="edit_affix" style="display: none;">
			<br>

			<div class="slider"></div>
		</div>
	</div>
	<div class="legendary_affix"></div>
	<div class="set_affix"></div>
	<div class="set">
		<div class="name"></div>
		<div class="primary"></div>
		<div class="secondary"></div>
		<div class="legendary"></div>
	</div>
	<div class="active_skill">
		<span class="label"></span>
		<input type="checkbox" />
	</div>
</div>

<table style="width:100%;">
	<tr>
		<td colspan="2">
			<span>
				<input type="button" id="import_begin" value="import"/>
				<span class="import">
					<input type="text" id="bid" value=""/>
					<input type="button" id="fetch" value="fetch"/>
					<select id="character_list"></select>
					<input type="button" id="import_end" value="import"/>
				</span>

				<select id="class_list"></select>
			</span>
		</td>
	</tr>
	<tr>
		<td class="data">
			<div class="totals">
				<table>
					<thead><tr><td>
						Offensive Stats
					</td></tr></thead>
					<tr id="strength">
						<td>

						</td>
					</tr>
					<tr id="dexterity">
						<td>

						</td>
					</tr>
					<tr id="intelligence">
						<td>

						</td>
					</tr>
					<tr id="vitality">
						<td>

						</td>
					</tr>
					<tr id="attack_speed">
						<td>

						</td>
					</tr>
					<tr id="critical_hit_chance">
						<td>

						</td>
					</tr>
					<tr id="critical_hit_damage">
						<td>

						</td>
					</tr>
					<tr id="fire_damage" class="elemental_damage">
						<td>

						</td>
					</tr>
					<tr id="holy_damage" class="elemental_damage">
						<td>

						</td>
					</tr>
					<tr id="elemental_damage"  class="elemental_damage">
						<td>

						</td>
					</tr>
					<tr id="elite_damage">
						<td>

						</td>
					</tr>
				</table>
			</div>
			<div class="damage">
				<table>
					<thead><tr><td>
						Damage Stats
					</td></tr></thead>
					<tr id="sheet_dps">
						<td>
							<span class="label"></span><span class="value"></span>
						</td>
					</tr>
					<tr id="elemental_dps">
						<td>
							<span class="label"></span><span class="value"></span>
						</td>
					</tr>
					<tr id="elite_dps">
						<td>
							<span class="label"></span><span class="value"></span>
						</td>
					</tr>
					<tr id="elemental_elite_dps">
						<td>
							<span class="label"></span><span class="value"></span>
						</td>
					</tr>
				</table>
			</div>
			<div class="stat_amounts">

			</div>
			<div id="active_skills">
				<table>
					<thead><tr><td>
						Active Skills
					</td></tr></thead>
				</table>
			</div>
		</td>
		<td>
			<div class="center_contents">
			<div class="paperdoll">
			<div class="equipment_row">
				<div class="slot" id="shoulders">
					shoulders
					<br>
					<div class="edit">
						<select class="item shoulders chosen-select"></select>
						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
				<div class="slot" id="head">
					head
					<br>
					<div class="edit">
						<select class="item head chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
				<div class="slot" id="neck">
					neck
					<br>

					<div class="edit">
						<select class="item neck chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
			</div>
			<div style="clear: both;"></div>
			<div class="equipment_row">
				<div class="slot" id="hands">
					hands
					<br>

					<div class="edit">
						<select class="item hands chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
				<div class="slot" id="chest">
					chest
					<br>

					<div class="edit">
						<select class="item chest chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
				<div class="slot" id="wrists">
					wrists
					<br>

					<div class="edit">
						<select class="item wrists chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
			</div>
			<div style="clear: both;"></div>
			<div class="equipment_row">
				<div class="slot" id="lfinger">
					finger
					<br>

					<div class="edit">
						<select class="item finger chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
				<div class="slot" id="waist">
					waist
					<br>

					<div class="edit">
						<select class="item waist chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
				<div class="slot" id="rfinger">
					finger
					<br>

					<div class="edit">
						<select class="item finger chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
			</div>
			<div style="clear: both;"></div>
			<div class="equipment_row">
				<div class="slot" id="mainhand">
					mainhand
					<br>

					<div class="edit">
						<select class="item group onehand twohand chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
				<div class="slot" id="legs">
					legs
					<br>

					<div class="edit">
						<select class="item legs chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
				<div class="slot" id="offhand">
					offhand
					<br>

					<div class="edit">
						<select class="item group shield mojo source quiver cshield chosen-select"></select>

						<div class="affix">
							<div class="primary">
								<select multiple class="chosen-select"></select>
							</div>
						</div>
						<div class="buttons">
							<span class="ui-icon ui-icon-check save_button"></span>
							<span class="ui-icon ui-icon-close cancel_button"></span>
						</div>
					</div>
					<div class="view">
						<div>
							<div class="name"></div>
							<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
						<div style="clear: both;"></div>
						<div class="affixes"></div>
					</div>
					<div class="stats">
						<div class="perfection"></div>
						<div class="dps_loss"></div>
					</div>
				</div>
			</div>
			<div style="clear: both;"></div>
				<div class="equipment_row">
					<div class="set_bonuses set"></div>
					<div class="slot" id="feet">
						feet
						<br>

						<div class="edit">
							<select class="item feet chosen-select"></select>

							<div class="affix">
								<div class="primary">
									<select multiple class="chosen-select"></select>
								</div>
							</div>
							<div class="buttons">
								<span class="ui-icon ui-icon-check save_button"></span>
								<span class="ui-icon ui-icon-close cancel_button"></span>
							</div>
						</div>
						<div class="view">
							<div>
								<div class="name"></div>
								<span style="float:right;" class="ui-icon ui-icon-gear edit_button"></span></div>
							<div style="clear: both;"></div>
							<div class="affixes"></div>
						</div>
						<div class="stats">
							<div class="perfection"></div>
							<div class="dps_loss"></div>
						</div>
					</div>
					<div class="legendary_affixes legendary"></div>
				</div>
			</div>
			</div>
		</td>
	</tr>
	<tr class="skills">
		<td colspan="2">
			<select id="passive-0" class="skill passive"></select>
			<select id="passive-1" class="skill passive"></select>
			<select id="passive-2" class="skill passive"></select>
			<select id="passive-3" class="skill passive"></select>
		</td>
	</tr>
	<tr  class="skills">
		<td colspan="2">
			<table>
				<tr>
					<td>
						<select id="active-0" class="skill active"></select>
					</td>
					<td>
						<select id="active-1" class="skill active"></select>
					</td>
					<td>
						<select id="active-2" class="skill active"></select>
					</td>
					<td>
						<select id="active-3" class="skill active"></select>
					</td>
					<td>
						<select id="active-4" class="skill active"></select>
					</td>
					<td>
						<select id="active-5" class="skill active"></select>
					</td>
				</tr>
				<tr>
					<td>
						<select id="rune-0" class="skill rune"></select>
					</td>
					<td>
						<select id="rune-1" class="skill rune"></select>
					</td>
					<td>
						<select id="rune-2" class="skill rune"></select>
					</td>
					<td>
						<select id="rune-3" class="skill rune"></select>
					</td>
					<td>
						<select id="rune-4" class="skill rune"></select>
					</td>
					<td>
						<select id="rune-5" class="skill rune"></select>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr style="display: none;">
		<td colspan="2">
			<div id="skill_damage">
				<table>
					<thead>
						<tr>
							<td>

							</td>
							<td></td>
							<td colspan="3">
								<span class="label header">Damage</span>
							</td>
							<td colspan="3">
								<span class="label header">Crit Damage</span>
							</td>
						</tr>
					</thead>
					<tr>
						<td>
							<span class="label">Skill Damage</span>&nbsp;<input id="skill_percent" type="text" value="100" style="width:60px;"/>%
							<select id="skill_element" class="chosen-select" style="width:80px;"></select>
						</td>
						<td></td>
						<td>
							<span id="min" class="min"></span></td><td>-</td><td><span id="max" class="max"></span>
						</td>
						<td>
							<span id="c_min" class="min"></span></td><td>-</td><td><span id="c_max" class="max"></span>
						</td>
					</tr>
					<tr>
						<td></td>
						<td>
							<span class="label">Elemental</span>
						</td>
						<td>
							<span id="ele_min" class="min"></span></td><td>-</td><td><span id="ele_max" class="max"></span>
						</td>
						<td>
							<span id="ele_c_min" class="min"></span></td><td>-</td><td><span id="ele_c_max" class="max"></span>
						</td>
					</tr>
					<tr>
						<td></td>
						<td>
							<span class="label">Elite</span>
						</td>
						<td>
							<span id="eli_min" class="min"></span></td><td>-</td><td><span id="eli_max" class="max"></span>
						</td>
						<td>
							<span id="eli_c_min" class="min"></span></td><td>-</td><td><span id="eli_c_max" class="max"></span>
						</td>
					</tr>
					<tr>
						<td></td>
						<td>
							<span class="label">Elemental Elite</span>
						</td>
						<td>
							<span id="ele_eli_min" class="min"></span></td><td>-</td><td><span id="ele_eli_max" class="max"></span>
						</td>
						<td>
							<span id="ele_eli_c_min" class="min"></span></td><td>-</td><td><span id="ele_eli_c_max" class="max"></span>
						</td>
					</tr>
				</table>
			</div>
		</td>
	</tr>
</table>

<a id="debug" href="#">debug</a>
<div id="debug_output"></div>